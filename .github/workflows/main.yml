# name: Deploy to Staging Server

# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:

# jobs:
#   deploy:
#     name: Deploy to Staging
#     runs-on: ubuntu-latest
    
#     env:
#       DEPLOY_PATH: /home3/ayodejis/api.ayodejisticksdev.com.ng
#       PHP_PATH: /opt/cpanel/ea-php82/root/usr/bin

#     steps:
#       - name: Checkout Code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Setup PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.2'
#           extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql
#           tools: composer:v2
#           coverage: none

#       - name: Validate composer.json and composer.lock
#         run: composer validate --strict

#       - name: Cache Composer packages
#         id: composer-cache
#         uses: actions/cache@v3
#         with:
#           path: vendor
#           key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
#           restore-keys: |
#             ${{ runner.os }}-php-

#       - name: Install Dependencies
#         run: |
#           composer install --prefer-dist --no-progress --no-interaction --no-dev
#           composer dump-autoload --optimize

#       - name: Prepare Deployment Package
#         run: |
#           # Remove development files
#           rm -f .env.example
#           rm -f composer.json composer.lock
#           find . -name "*.md" -delete
          
#           # Create deployment archive
#           tar -czf deployment.tar.gz --exclude='.git' --exclude='.github' --exclude='deployment.tar.gz' .

#       - name: Deploy to Server
#         uses: appleboy/scp-action@v0.1.3
#         with:
#           host: ${{ secrets.REMOTE_HOST }}
#           username: ${{ secrets.REMOTE_USER }}
#           port: ${{ secrets.SSH_REMOTE_PORT }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           source: "deployment.tar.gz"
#           target: "${{ env.DEPLOY_PATH }}"
#           strip_components: 0

#       - name: Execute Server Deployment
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.REMOTE_HOST }}
#           username: ${{ secrets.REMOTE_USER }}
#           port: ${{ secrets.SSH_REMOTE_PORT }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script_stop: true
#           script: |
#             set -euo pipefail
            
#             cd ${{ env.DEPLOY_PATH }}
            
#             # Backup current deployment
#             if [ -d "current" ]; then
#               timestamp=$(date +%Y%m%d_%H%M%S)
#               cp -r current "backup_$timestamp"
#             fi
            
#             # Extract new deployment
#             tar -xzf deployment.tar.gz -C .
#             rm -f deployment.tar.gz
            
#             # Ensure proper PHP version
#             export PATH=${{ env.PHP_PATH }}:$PATH
            
#             # Environment setup
#             if [ ! -f ".env" ]; then
#               echo "Warning: .env file not found. Please ensure it's configured."
#             fi
            
#             # Install production dependencies (without dev dependencies)
#             /opt/cpanel/ea-php82/root/usr/bin/php /opt/cpanel/composer/bin/composer install --no-dev --optimize-autoloader --no-interaction
            
#             # Set secure permissions
#             find . -type f -exec chmod 644 {} \;
#             find . -type d -exec chmod 755 {} \;
#             chmod -R 775 storage/
#             chmod -R 775 bootstrap/cache/
#             chgrp -R hospital storage bootstrap/cache
            
#             # Laravel specific optimizations
#             /opt/cpanel/ea-php82/root/usr/bin/php artisan config:cache
#             /opt/cpanel/ea-php82/root/usr/bin/php artisan route:cache
#             /opt/cpanel/ea-php82/root/usr/bin/php artisan view:cache
            
#             # Run migrations safely
#             read -r -p "Run database migrations? (y/N): " response
#             if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
#               /opt/cpanel/ea-php82/root/usr/bin/php artisan migrate --force
#             else
#               echo "Skipping database migrations"
#             fi
            
#             # Clear and cache again
#             /opt/cpanel/ea-php82/root/usr/bin/php artisan optimize:clear
#             /opt/cpanel/ea-php82/root/usr/bin/php artisan config:cache
#             /opt/cpanel/ea-php82/root/usr/bin/php artisan route:cache
            
#             # Cleanup old backups (keep last 5)
#             ls -dt backup_* | tail -n +6 | xargs rm -rf
            
#             echo "‚úÖ Deployment completed successfully!"

#       - name: Verify Deployment
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.REMOTE_HOST }}
#           username: ${{ secrets.REMOTE_USER }}
#           port: ${{ secrets.SSH_REMOTE_PORT }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script: |
#             cd ${{ env.DEPLOY_PATH }}
#             export PATH=${{ env.PHP_PATH }}:$PATH
            
#             # Verify Laravel installation
#             if /opt/cpanel/ea-php82/root/usr/bin/php artisan --version > /dev/null 2>&1; then
#               echo "‚úÖ Laravel artisan command working"
#             else
#               echo "‚ùå Laravel artisan command failed"
#               exit 1
#             fi
            
#             # Check storage permissions
#             if [ -w "storage" ] && [ -w "bootstrap/cache" ]; then
#               echo "‚úÖ Storage directories are writable"
#             else
#               echo "‚ùå Storage directory permissions issue"
#               exit 1
#             fi
            
#             echo "üéâ Deployment verification passed!"


name: Deploy Laravel to cPanel

on:
  push:
    branches:
      - main  # change to your deployment branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, gd, pdo_mysql, bcmath, xml, curl, zip
          tools: composer
          coverage: none

      - name: Cache composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-${{ runner.os }}-

      - name: Install PHP dependencies
        run: |
          composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

      # Optional: build front-end if your Laravel app uses Vite/NPM
      - name: Setup Node
        if: ${{ hashFiles('**/package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install and build front-end
        if: ${{ hashFiles('**/package.json') != '' }}
        run: |
          npm ci
          npm run build

      - name: Prepare deployment package
        run: |
          mkdir -p deploy
          rsync -av --delete \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="node_modules" \
            --exclude="tests" \
            --exclude=".env" \
            --exclude="storage/logs/*" \
            --exclude="storage/framework/sessions/*" \
            --exclude="storage/framework/testing/*" \
            ./ deploy/
          # Ensure built assets and vendor are included
          cp -r vendor deploy/vendor
          if [ -d "public/build" ]; then
            mkdir -p deploy/public
            cp -r public/build deploy/public/build
          fi

      # Choose ONE of the deploy methods below.
      # --- Method A: FTPS (recommended if SSH/SFTP is not available) ---
      - name: Deploy via FTPS
        if: ${{ env.DEPLOY_METHOD != 'sftp' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USERNAME }}
          password: ${{ secrets.CPANEL_PASSWORD }}
          port: ${{ secrets.CPANEL_PORT }}
          protocol: ${{ secrets.CPANEL_PROTOCOL }} # 'ftps'
          local-dir: deploy
          server-dir: ${{ secrets.CPANEL_PATH }}
          # Safety: only remove files that we deployed
          exclude: |
            **/.git*
            **/.github/**
            node_modules/**
            tests/**
            .env

      # --- Method B: SFTP (secure, requires SSH access) ---
      - name: Deploy via SFTP
        if: ${{ env.DEPLOY_METHOD == 'sftp' }}
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USERNAME }}
          password: ${{ secrets.CPANEL_PASSWORD }}
          port: ${{ secrets.CPANEL_PORT }}
          protocol: ${{ secrets.CPANEL_PROTOCOL }} # 'sftp'
          local_path: 'deploy/*'
          remote_path: ${{ secrets.CPANEL_PATH }}
          ssh_private_key: ${{ secrets.SFTP_SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SFTP_SSH_PASSphrase }}

      - name: Post-deploy sanity hints
        run: |
          echo "Deployment finished."
          echo "Ensure server .env is present and correct."
          echo "Set write perms for storage and bootstrap/cache on server."

